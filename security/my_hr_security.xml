<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- ===== Groups ===== -->
    <record id="group_my_hr_employee" model="res.groups">
        <field name="name">My HR / Employee</field>
        <field name="category_id" ref="base.module_category_human_resources"/>
        <field name="implied_ids" eval="[(4, ref('base.group_user'))]"/>
    </record>

    <record id="group_my_hr_manager" model="res.groups">
        <field name="name">My HR / Manager</field>
        <field name="category_id" ref="base.module_category_human_resources"/>
        <field name="implied_ids" eval="[(4, ref('group_my_hr_employee'))]"/>
    </record>

    <record id="group_my_hr_payroll" model="res.groups">
        <field name="name">My HR / Payroll Manager</field>
        <field name="category_id" ref="base.module_category_human_resources"/>
        <field name="implied_ids" eval="[(4, ref('group_my_hr_manager'))]"/>
    </record>

    <!-- ===== Record Rules ===== -->

    <!-- Payslip: employees see only their own; managers see all in company -->
    <record id="rule_payslip_employee" model="ir.rule">
        <field name="name">Payslip: employee sees own payslips</field>
        <field name="model_id" ref="model_my_hr_payslip"/>
        <field name="domain_force">[('employee_id.user_id', '=', user.id)]</field>
        <field name="groups" eval="[(4, ref('group_my_hr_employee'))]"/>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
    </record>

    <record id="rule_payslip_manager" model="ir.rule">
        <field name="name">Payslip: manager sees all in company</field>
        <field name="model_id" ref="model_my_hr_payslip"/>
        <field name="domain_force">[('batch_id.company_id', 'in', user.company_ids.ids)]</field>
        <field name="groups" eval="[(4, ref('group_my_hr_payroll'))]"/>
    </record>

    <!-- Tasks: employees see only their own tasks; managers see their department's -->
    <record id="rule_task_employee" model="ir.rule">
        <field name="name">Task: employee sees own tasks</field>
        <field name="model_id" ref="model_my_hr_task"/>
        <field name="domain_force">[
            '|',
            ('employee_id.user_id', '=', user.id),
            ('manager_id.user_id', '=', user.id)
        ]</field>
        <field name="groups" eval="[(4, ref('group_my_hr_employee'))]"/>
    </record>

    <record id="rule_task_manager" model="ir.rule">
        <field name="name">Task: manager sees department tasks</field>
        <field name="model_id" ref="model_my_hr_task"/>
        <field name="domain_force">[('employee_id.department_id.manager_id.user_id', '=', user.id)]</field>
        <field name="groups" eval="[(4, ref('group_my_hr_manager'))]"/>
    </record>

    <!-- Payroll Batch: only payroll managers -->
    <record id="rule_payroll_batch_company" model="ir.rule">
        <field name="name">Payroll Batch: company scope</field>
        <field name="model_id" ref="model_my_hr_payroll_batch"/>
        <field name="domain_force">[('company_id', 'in', user.company_ids.ids)]</field>
        <field name="groups" eval="[(4, ref('group_my_hr_payroll'))]"/>
    </record>
</odoo>